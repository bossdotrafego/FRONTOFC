<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pagamento Pix ‚Äî Plano Anual</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&amp;display=swap" rel="stylesheet">
    <style>
        :root { --red: #d61625; --dark: #222; --white: #fff; --gray: #666; --radius: 6px; --maxW: 480px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: #f5f5f5; color: var(--dark); line-height: 1.4; padding-top: 40px; }
        .container { width: 100%; max-width: var(--maxW); margin: 20px auto; padding: 0 15px; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px; overflow: hidden; }
        .card-image { width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background: #f5f5f5; }
        .card-image img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .card-header { background: var(--red); color: #fff; text-align: center; padding: 12px; font-size: 1.1rem; }
        .card-body { padding: 20px; }
        h2.form-title { text-align: center; margin-bottom: 15px; font-weight: 600; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: .9rem; color: var(--dark); }
        .form-group input { width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: var(--radius); transition: border-color .2s; }
        .form-group input:focus { outline: none; border-color: var(--red); }
        .form-group input.error { border-color: #dc3545; }
        .error-message { color: #dc3545; font-size: 0.85rem; margin-top: 4px; display: none; }
        .btn { width: 100%; padding: 12px; background: var(--red); color: #fff; border: none; border-radius: var(--radius); font-size: 1rem; margin-top: 10px; cursor: pointer; transition: opacity .2s; }
        .btn:disabled { background: #aaa; cursor: not-allowed; }
        .btn-copy { 
            background: #28a745; 
            margin-top: 15px; 
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }
        .btn-copy:hover { background: #218838; }
        .btn-copy.copiado { 
            background: #17a2b8; 
            animation: pulse 0.6s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #area-pix { text-align: center; }
        #area-pix h2 { margin-bottom: 10px; }
        #area-pix img { max-width: 250px; margin: 15px auto; display: block; }
        #pix-copia-cola { width: 100%; padding: 10px; font-family: monospace; text-align: center; margin-top: 10px; font-size: 0.9rem; }
        .hidden { display: none; }
        .redirect-info { background: #e8f4fd; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .redirect-info h3 { color: #007bff; margin-bottom: 10px; }
        .redirect-timer { font-size: 1.1rem; font-weight: bold; color: #007bff; }
        
        /* Estilo para mensagem de sucesso */
        .copy-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 8px 12px;
            border-radius: var(--radius);
            margin-top: 10px;
            font-size: 0.9rem;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-image">
                <img src="images/card3.jpeg" alt="PLANO ANUAL 365 DIAS">
            </div>
            <div class="card-header">
                PLANO ANUAL 365 DIAS ‚Äî R$ 161,90
            </div>
            <div class="card-body">
                <div id="secao-formulario">
                    <h2 class="form-title">Dados para Entrega do C√≥digo</h2>
                    <form id="formCliente">
                        <div class="form-group">
                            <label for="cli_nome">Nome completo</label>
                            <input type="text" id="cli_nome" name="cli_nome" required placeholder="Seu nome completo">
                            <div class="error-message" id="erro-nome">Nome √© obrigat√≥rio</div>
                        </div>
                        <div class="form-group">
                            <label for="cli_whatsapp">WhatsApp (com DDD)</label>
                            <input type="tel" id="cli_whatsapp" name="cli_whatsapp" required placeholder="(11) 99999-9999">
                            <div class="error-message" id="erro-whatsapp">WhatsApp deve ter 11 d√≠gitos</div>
                        </div>
                        <button type="submit" class="btn" id="btnGerar">Gerar Pix</button>
                    </form>
                </div>

                <div id="area-pix" class="hidden">
                    <h2>Pague com PIX para receber seu c√≥digo!</h2>
                    <p>Escaneie o QR Code com o app do seu banco:</p>
                    <img id="qr-code-img" src="" alt="QR Code PIX">
                    <p>Ou use o PIX Copia e Cola:</p>
                    <textarea id="pix-copia-cola" rows="4" readonly></textarea>
                    
                    <button id="btn-copiar-pix" class="btn btn-copy">
                        üìã COPIAR C√ìDIGO PIX
                    </button>
                    
                    <div id="copy-message" class="copy-success hidden">
                        ‚úÖ C√≥digo PIX copiado! Cole no seu app do banco para pagar.
                    </div>
                    
                    <div class="redirect-info">
                        <h3>üéØ Aguardando pagamento...</h3>
                        <p>Ap√≥s o pagamento, voc√™ receber√° seu c√≥digo por <strong>WhatsApp</strong> e ser√° redirecionado para a p√°gina de confirma√ß√£o!</p>
                        <div class="redirect-timer">
                            ‚è±Ô∏è Verificando a cada <span id="timer">10</span> segundos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('formCliente');
        let idPagamento = null;
        let intervaloPagamento = null;

        // M√°scara para WhatsApp
        const whatsappInput = document.getElementById('cli_whatsapp');
        whatsappInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length >= 6) {
                    value = value.replace(/^(\d{2})(\d{4,5})(\d{4})$/, '($1) $2-$3');
                } else if (value.length >= 2) {
                    value = value.replace(/^(\d{2})(\d+)/, '($1) $2');
                }
                e.target.value = value;
            } else {
                e.target.value = e.target.value.slice(0, -1);
            }
        });

        // Valida√ß√£o de WhatsApp
        function validarWhatsApp(whatsapp) {
            const numeros = whatsapp.replace(/\D/g, '');
            return numeros.length === 11 && numeros.charAt(2) === '9';
        }

        // Valida√ß√£o do formul√°rio
        function validarFormulario() {
            const nome = document.getElementById('cli_nome').value.trim();
            const whatsapp = document.getElementById('cli_whatsapp').value;
            
            let valido = true;

            // Limpar erros anteriores
            document.querySelectorAll('.form-group input').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(msg => {
                msg.style.display = 'none';
            });

            // Validar nome
            if (nome.length < 3) {
                document.getElementById('cli_nome').classList.add('error');
                document.getElementById('erro-nome').style.display = 'block';
                valido = false;
            }

            // Validar WhatsApp
            if (!validarWhatsApp(whatsapp)) {
                document.getElementById('cli_whatsapp').classList.add('error');
                document.getElementById('erro-whatsapp').style.display = 'block';
                valido = false;
            }

            return valido;
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!validarFormulario()) {
                return;
            }

            const nome = document.getElementById('cli_nome').value.trim();
            const whatsapp = document.getElementById('cli_whatsapp').value.replace(/\D/g, ''); // S√≥ n√∫meros
            
            const plano = "PLANO ANUAL 365 DIAS";
            const valor = 161.90;

            const submitButton = document.getElementById('btnGerar');
            submitButton.innerText = 'Gerando...';
            submitButton.disabled = true;

            try {
                const response = await fetch('https://unitv.onrender.com/api/gerar-pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, whatsapp, plano, valor })
                });

                const data = await response.json();

                if (data.sucesso) {
                    // Esconder formul√°rio e mostrar PIX
                    document.getElementById('secao-formulario').classList.add('hidden');
                    const areaPix = document.getElementById('area-pix');
                    areaPix.classList.remove('hidden');
                    
                    // Preencher dados do PIX
                    document.getElementById('qr-code-img').src = 'data:image/png;base64,' + data.qr_code_base64;
                    document.getElementById('pix-copia-cola').value = data.qr_code;
                    
                    // Guardar ID do pagamento
                    idPagamento = data.id_pagamento;
                    
                    // Configurar bot√£o de copiar
                    configurarBotaoCopiar();
                    
                    // Iniciar verifica√ß√£o autom√°tica
                    iniciarVerificacaoPagamento();
                } else {
                    alert('Erro ao gerar PIX: ' + data.erro);
                    submitButton.innerText = 'Gerar Pix';
                    submitButton.disabled = false;
                }
            } catch (error) {
                alert('N√£o foi poss√≠vel conectar ao servidor. Verifique se ele est√° rodando e tente novamente.');
                console.error('Erro de conex√£o:', error);
                submitButton.innerText = 'Gerar Pix';
                submitButton.disabled = false;
            }
        });

        function configurarBotaoCopiar() {
            const btnCopiar = document.getElementById('btn-copiar-pix');
            const pixCopiaCola = document.getElementById('pix-copia-cola');
            const copyMessage = document.getElementById('copy-message');

            btnCopiar.addEventListener('click', async function() {
                try {
                    // Copiar para √°rea de transfer√™ncia
                    await navigator.clipboard.writeText(pixCopiaCola.value);
                    
                    // Feedback visual no bot√£o
                    const textoOriginal = btnCopiar.textContent;
                    btnCopiar.textContent = '‚úÖ COPIADO!';
                    btnCopiar.classList.add('copiado');
                    
                    // Mostrar mensagem de sucesso
                    copyMessage.classList.remove('hidden');
                    
                    // Restaurar bot√£o ap√≥s 2 segundos
                    setTimeout(() => {
                        btnCopiar.textContent = textoOriginal;
                        btnCopiar.classList.remove('copiado');
                    }, 2000);
                    
                    // Esconder mensagem ap√≥s 3 segundos
                    setTimeout(() => {
                        copyMessage.classList.add('hidden');
                    }, 3000);
                    
                } catch (err) {
                    // Fallback para navegadores que n√£o suportam clipboard API
                    pixCopiaCola.select();
                    pixCopiaCola.setSelectionRange(0, 99999); // Para mobile
                    
                    try {
                        document.execCommand('copy');
                        
                        const textoOriginal = btnCopiar.textContent;
                        btnCopiar.textContent = '‚úÖ COPIADO!';
                        btnCopiar.classList.add('copiado');
                        
                        copyMessage.classList.remove('hidden');
                        
                        setTimeout(() => {
                            btnCopiar.textContent = textoOriginal;
                            btnCopiar.classList.remove('copiado');
                        }, 2000);
                        
                        setTimeout(() => {
                            copyMessage.classList.add('hidden');
                        }, 3000);
                        
                    } catch (fallbackErr) {
                        alert('N√£o foi poss√≠vel copiar automaticamente. Por favor, selecione e copie o c√≥digo manualmente.');
                    }
                }
            });
        }

        function iniciarVerificacaoPagamento() {
            let contador = 10;
            const timerElement = document.getElementById('timer');
            
            // Verificar imediatamente
            verificarStatusPagamento();
            
            // Depois verificar a cada 10 segundos
            intervaloPagamento = setInterval(() => {
                verificarStatusPagamento();
                
                // Atualizar contador visual
                contador--;
                if (contador <= 0) {
                    contador = 10;
                }
                timerElement.textContent = contador;
            }, 10000);
            
            // Atualizar contador visual a cada segundo
            setInterval(() => {
                contador--;
                if (contador <= 0) {
                    contador = 10;
                }
                timerElement.textContent = contador;
            }, 1000);
        }

        async function verificarStatusPagamento() {
            if (!idPagamento) return;
            
            try {
                const response = await fetch('https://unitv.onrender.com/api/verificar-pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_pagamento: idPagamento })
                });
                
                const data = await response.json();
                
                if (data.sucesso && data.status === 'approved' && data.codigo) {
                    // Pagamento aprovado! Redirecionar para p√°gina de obrigado
                    clearInterval(intervaloPagamento);
                    window.location.href = `https://unitv.onrender.com/obrigado.html?id=${idPagamento}`;
                }
            } catch (error) {
                console.error('Erro ao verificar pagamento:', error);
            }
        }
    </script>
</body>
</html>
