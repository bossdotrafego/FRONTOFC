<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pagamento Pix ‚Äî Plano Mensal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&amp;display=swap" rel="stylesheet">
    <style>
        :root { --red: #d61625; --dark: #222; --white: #fff; --gray: #666; --radius: 6px; --maxW: 480px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: #f5f5f5; color: var(--dark); line-height: 1.4; padding-top: 40px; }
        .container { width: 100%; max-width: var(--maxW); margin: 20px auto; padding: 0 15px; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px; overflow: hidden; }
        .card-image { width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background: #f5f5f5; }
        .card-image img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .card-header { background: var(--red); color: #fff; text-align: center; padding: 12px; font-size: 1.1rem; }
        .card-body { padding: 20px; }
        h2.form-title { text-align: center; margin-bottom: 15px; font-weight: 600; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: .9rem; color: var(--dark); }
        .form-group input { width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: var(--radius); transition: border-color .2s; }
        .form-group input:focus { outline: none; border-color: var(--red); }
        .btn { width: 100%; padding: 12px; background: var(--red); color: #fff; border: none; border-radius: var(--radius); font-size: 1rem; margin-top: 10px; cursor: pointer; transition: opacity .2s; }
        .btn:disabled { background: #aaa; cursor: not-allowed; }
        #area-pix { text-align: center; }
        #area-pix h2 { margin-bottom: 10px; }
        #area-pix img { max-width: 250px; margin: 15px auto; display: block; }
        #pix-copia-cola { width: 100%; padding: 10px; font-family: monospace; text-align: center; margin-top: 10px; font-size: 0.9rem; }
        .hidden { display: none; }
        .redirect-info { background: #e8f4fd; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-top: 15px; }
        .redirect-info h3 { color: #007bff; margin-bottom: 10px; }
        .redirect-timer { font-size: 1.1rem; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-image">
                <img src="images/card1.jpeg" alt="PLANO MENSAL 30 DIAS">
            </div>
            <div class="card-header">
                PLANO MENSAL 30 DIAS ‚Äî R$ 24,90
            </div>
            <div class="card-body">
                <div id="secao-formulario">
                    <h2 class="form-title">Dados Pessoais</h2>
                    <form id="formCliente">
                        <div class="form-group">
                            <label for="cli_nome">Nome completo</label>
                            <input type="text" id="cli_nome" name="cli_nome" required placeholder="Seu nome completo">
                        </div>
                        <div class="form-group">
                            <label for="cli_email">E-mail</label>
                            <input type="email" id="cli_email" name="cli_email" required placeholder="seu@exemplo.com">
                        </div>
                        <div class="form-group">
                            <label for="cli_cpf">CPF</label>
                            <input type="text" id="cli_cpf" name="cli_cpf" required placeholder="000.000.000-00">
                        </div>
                        <button type="submit" class="btn" id="btnGerar">Gerar Pix</button>
                    </form>
                </div>

                <div id="area-pix" class="hidden">
                    <h2>Pague com PIX para receber seu c√≥digo!</h2>
                    <p>Escaneie o QR Code com o app do seu banco:</p>
                    <img id="qr-code-img" src="" alt="QR Code PIX">
                    <p>Ou use o PIX Copia e Cola:</p>
                    <textarea id="pix-copia-cola" rows="4" readonly></textarea>
                    
                    <div class="redirect-info">
                        <h3>üéØ Aguardando pagamento...</h3>
                        <p>Ap√≥s o pagamento ser aprovado, voc√™ ser√° redirecionado automaticamente para receber seu c√≥digo UniTV!</p>
                        <div class="redirect-timer">
                            ‚è±Ô∏è Verificando a cada <span id="timer">10</span> segundos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('formCliente');
        let idPagamento = null;
        let intervaloPagamento = null;

        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            const nome = document.getElementById('cli_nome').value;
            const email = document.getElementById('cli_email').value;
            
            const plano = "PLANO MENSAL 30 DIAS";
            const valor = 24.90;

            const submitButton = document.getElementById('btnGerar');
            submitButton.innerText = 'Gerando...';
            submitButton.disabled = true;

            try {
                const response = await fetch('https://unitv.onrender.com/api/gerar-pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, plano, valor })
                });

                const data = await response.json();

                if (data.sucesso) {
                    // Esconder formul√°rio e mostrar PIX
                    document.getElementById('secao-formulario').classList.add('hidden');
                    const areaPix = document.getElementById('area-pix');
                    areaPix.classList.remove('hidden');
                    
                    // Preencher dados do PIX
                    document.getElementById('qr-code-img').src = 'data:image/png;base64,' + data.qr_code_base64;
                    document.getElementById('pix-copia-cola').value = data.qr_code;
                    
                    // Guardar ID do pagamento
                    idPagamento = data.id_pagamento;
                    
                    // Iniciar verifica√ß√£o autom√°tica
                    iniciarVerificacaoPagamento();
                } else {
                    alert('Erro ao gerar PIX: ' + data.erro);
                    submitButton.innerText = 'Gerar Pix';
                    submitButton.disabled = false;
                }
            } catch (error) {
                alert('N√£o foi poss√≠vel conectar ao servidor. Verifique se ele est√° rodando e tente novamente.');
                console.error('Erro de conex√£o:', error);
                submitButton.innerText = 'Gerar Pix';
                submitButton.disabled = false;
            }
        });

        function iniciarVerificacaoPagamento() {
            let contador = 10;
            const timerElement = document.getElementById('timer');
            
            // Verificar imediatamente
            verificarStatusPagamento();
            
            // Depois verificar a cada 10 segundos
            intervaloPagamento = setInterval(() => {
                verificarStatusPagamento();
                
                // Atualizar contador visual
                contador--;
                if (contador <= 0) {
                    contador = 10;
                }
                timerElement.textContent = contador;
            }, 10000);
            
            // Atualizar contador visual a cada segundo
            setInterval(() => {
                contador--;
                if (contador <= 0) {
                    contador = 10;
                }
                timerElement.textContent = contador;
            }, 1000);
        }

        async function verificarStatusPagamento() {
            if (!idPagamento) return;
            
            try {
                const response = await fetch('https://unitv.onrender.com/api/verificar-pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_pagamento: idPagamento })
                });
                
                const data = await response.json();
                
                if (data.sucesso && data.status === 'approved' && data.codigo) {
                    // Pagamento aprovado! Redirecionar para p√°gina de obrigado
                    clearInterval(intervaloPagamento);
                    window.location.href = `https://unitv.onrender.com/obrigado.html?id=${idPagamento}`;
                }
            } catch (error) {
                console.error('Erro ao verificar pagamento:', error);
            }
        }
    </script>
</body>
</html>
